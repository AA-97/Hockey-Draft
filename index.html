<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fantasy Hockey Draft - Team Roster Entry</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }

    /* Z-INDEX FIX: Ensure the modal is always on top (over the loading screen/form) */
    #custom-modal-backdrop { z-index: 1000; }
    #custom-modal { z-index: 1010; }

    .loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.95); display: flex; justify-content: center;
        align-items: center; z-index: 99; flex-direction: column; /* Lower than modal */
    }
    .roster-locked .select-wrapper::after {
        content: 'LOCKED';
        position: absolute;
        top: 50%;
        right: 1rem;
        transform: translateY(-50%);
        padding: 2px 8px;
        background-color: #fca5a5; /* Red-300 */
        color: #7f1d1d; /* Red-900 */
        font-size: 0.75rem;
        font-weight: bold;
        border-radius: 4px;
    }
    /* Style for disabled select in locked mode */
    .roster-locked select:disabled {
        background-color: #eef2ff; /* Indigo-50 for a clean locked look */
        color: #1e3a8a; /* Blue-900 */
        font-weight: 600;
        border-color: #a5b4fc; /* Indigo-300 */
        opacity: 1; /* Override default opacity for disabled elements */
        cursor: default;
    }
  </style>
  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- GLOBAL STATE & FIREBASE SETUP ---
    let db = null;
    let auth = null;
    let currentUserId = null;
    window.users = [];

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    // CRITICAL: Ensure firebaseConfig is used safely
    let firebaseConfig = {};
    try {
        // FIX: If __firebase_config is an empty string, JSON.parse will fail, but typeof check is correct.
        // Assuming __firebase_config should be JSON string or undefined/missing.
        firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config.length > 0 ? JSON.parse(__firebase_config) : {};
    } catch (e) {
        console.error("Failed to parse firebase config, check if provided value is valid JSON:", e);
    }

    const USERS_COLLECTION_PATH = `/artifacts/${appId}/public/data/fantasy_users`;

    // --- Loading Timeout Setup ---
    let loadingTimer = null;
    const LOADING_TIMEOUT_MS = 7000; // 7 seconds before timeout

    function handleLoadingTimeout() {
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay.style.display !== 'none') {
            loadingOverlay.style.display = 'none';
            // Show a non-blocking modal to inform the user
            window.showModal(
                'Connection Slow',
                'The cloud database connection is taking longer than expected. You can still log in, but data might be delayed.',
                false
            );
        }
    }
    // --- End Loading Timeout Setup ---

    // Function to save the entire users array to Firestore
    async function saveUsersToDatabase(newUsers) {
        if (!db || !currentUserId) return;

        try {
            const docRef = doc(db, USERS_COLLECTION_PATH, 'data');
            // Use setDoc with merge: false to overwrite the single 'data' document
            await setDoc(docRef, { users: newUsers }, { merge: false });
            console.log("Data successfully saved to Firestore.");
        } catch (e) {
            console.error("Error writing document: ", e);
            window.showModal('Error', 'Failed to save data to the server. Check console for details.');
        }
    }

    // Real-time listener function
    function listenForUserData() {
        if (!db) return;

        const docRef = doc(db, USERS_COLLECTION_PATH, 'data');

        // Attach the real-time listener
        onSnapshot(docRef, (docSnap) => {
            // Clear the timeout when data arrives
            if (loadingTimer) {
                clearTimeout(loadingTimer);
                loadingTimer = null;
            }
            // Hide the loading overlay once initial data fetch is complete
            document.getElementById('loading-overlay').style.display = 'none';

            if (docSnap.exists() && docSnap.data().users) {
                window.users = docSnap.data().users;
                console.log("Data successfully loaded/updated from Firestore:", window.users);
            } else {
                // Initialize to an empty array if the document doesn't exist
                window.users = [];
            }

            // Once data is loaded/updated, check if the user is logged in
            window.checkSessionTeam();
        }, (error) => {
            console.error("Error listening to document: ", error);
            window.showModal('Database Error', 'Lost connection to real-time database.');
        });
    }

    // Initialization function
    async function initializeFirebaseApp() {
        // Check for missing critical configuration
        if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
            const reason = Object.keys(firebaseConfig).length === 0 ? "Configuration object is empty." : "Configuration object is missing apiKey property.";
            const errorMessage = "The database configuration is missing. Cannot initialize Firebase services. (" + reason + ")";

            console.error(errorMessage, "Configuration received:", firebaseConfig);

            document.getElementById('loading-overlay').style.display = 'none';
            window.showModal('Initialization Error', errorMessage + " Please refresh or contact support if the issue persists.");
            return; // Stop execution
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');

            // Correct variable name check (already fixed, but confirming)
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    listenForUserData();
                } else {
                    currentUserId = null;
                    document.getElementById('loading-overlay').style.display = 'none';
                    window.showModal('Error', 'Authentication failed. Please refresh.');
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed with full error:", error);
            window.showModal('Initialization Error', 'Could not connect to the database. Check the console for full error details.');
            document.getElementById('loading-overlay').style.display = 'none';
        }
    }

    // Start the app and the timeout immediately
    loadingTimer = setTimeout(handleLoadingTimeout, LOADING_TIMEOUT_MS);
    initializeFirebaseApp();
    window.saveUsersToDatabase = saveUsersToDatabase;
  </script>
  <script>
    (function() {
        window.users = window.users || [];
        const generateUniqueId = () => crypto.randomUUID();
        let resolveModal = null;
        // CRITICAL CHANGE: These are now in-memory variables, not using localStorage
        let currentTeamName = null;
        let currentTeamId = null;

        // --- FIXED PLAYER DATA ---
        const availableForwards = [
            ["Connor McDavid (EDM)", "Kyle Connor (WPG)", "Mikko Rantanen (DAL)", "Mitch Marner (TOR)", "Nikita Kucherov (TB)"],
            ["Alex Ovechkin (WAS)", "Jason Robertson (DAL)", "Leon Draisaitl (EDM)", "Nathan MacKinnon (COL)", "Sam Reinhart (FLA)"],
            ["Jack Eichel (VEG)", "Jesper Bratt (NJ)", "Martin Necas (COL)", "Nick Suzuki (MON)", "Robert Thomas (STL)"],
            ["Kirill Kaprizov (MIN)", "Mark Scheifele (WPG)", "Matt Duchene (DAL)", "Sebastian Aho (CAR)", "Tim Stutzle (OTT)"],
            ["Aleksander Barkov (FLA)", "Auston Matthews (TOR)", "Brandon Hagel (TB)", "Jordan Kyrou (STL)", "Wyatt Johnston (DAL)"],
            ["Adrian Kempe (LA)", "Brayden Point (TB)", "Cole Caufield (MON)", "Dylan Strome (WAS)", "Nikolaj Ehlers (WPG)"],
            ["Anze Kopitar (LA)", "Mark Stone (VEG)", "Matt Boldy (MIN)", "Seth Jarvis (CAR)", "William Nylander (TOR)"],
            ["Brady Tkachuk (OTT)", "Dylan Holloway (STL)", "Jake Guentzel (TB)", "Roope Hintz (DAL)", "Tomas Hertl (VEG)"],
            ["Aliaksei Protas (WAS)", "Andrei Svechnikov (CAR)", "Brock Nelson (COL)", "Nico Hischier (NJ)", "Ryan Nugent-Hopkins (EDM)"],
            ["Drake Batherson (OTT)", "John Tavares (TOR)", "Kevin Fiala (LA)", "Marco Rossi (MIN)", "Matthew Tkachuk (FLA)"],
            ["Gabriel Vilardi (WPG)", "Mikael Granlund (DAL)", "Patrik Laine (MON)", "Pavel Buchnevich (STL)", "Tom Wilson (WAS)"],
            ["Anthony Cirelli (TB)", "Brad Marchand (FLA)", "Ivan Barbashev (VEG)", "Mats Zuccarello (MIN)", "Pierre-Luc Dubois (WAS)"],
            ["Connor McMichael (WAS)", "Jonathan Drouin (COL)", "Matthew Knies (TOR)", "Sam Bennett (FLA)", "Zach Hyman (EDM)"],
            ["Claude Giroux (OTT)", "Joel Eriksson Ek (MIN)", "Quinton Byfield (LA)", "Taylor Hall (CAR)", "Timo Meier (NJ)"],
            ["Carter Verhaeghe (FLA)", "Cole Perfetti (WPG)", "Dawson Mercer (NJ)", "Juraj Slafkovsky (MON)", "Valeri Nichushkin (COL)"],
            ["Cale Makar (COL)", "Evan Bouchard (EDM)", "John Carlson (WAS)", "Shea Theodore (VEG)", "Victor Hedman (TB)"],
            ["Jake Sanderson (OTT)", "Josh Morrissey (WPG)", "Lane Hutson (MON)", "Shayne Gostisbehere (CAR)", "Thomas Harley (DAL)"],
            ["Aaron Ekblad (FLA)", "Cam Fowler (STL)", "Dougie Hamilton (NJ)", "Drew Doughty (LA)", "Morgan Rielly (TOR)"]
        ];
        const availableGoalies = [
            ["Andrei Vasilevskiy (TB)", "Connor Hellebuyck (WPG)", "Jake Oettinger (DAL)", "Logan Thompson (WAS)", "Sergei Bobrovsky (FLA)"],
            ["Adin Hill (VEG)", "Jordan Binnington (STL)", "Joseph Woll (TOR)", "Mackenzie Blackwood (COL)", "Pyotr Kochetkov (CAR)"],
            ["Darcy Kuemper (LA)", "Filip Gustavsson (MIN)", "Linus Ullmark (OTT)", "Sam Montembeault (MON)", "Stuart Skinner (EDM)"]
        ];

        // Flattened lists for easier sequential slicing (90 F/D players, 15 G players)
        const flatAvailableForwards = availableForwards.flat();
        const flatAvailableGoalies = availableGoalies.flat();

        const FORWARD_PICKS_COUNT = 18;
        const GOALIE_PICKS_COUNT = 3;
        const TOTAL_PICKS_REQUIRED = FORWARD_PICKS_COUNT + GOALIE_PICKS_COUNT;

        // --- Modal Implementation ---
        function showModal(title, message, isConfirmation = false) {
            const modal = document.getElementById('custom-modal');
            const backdrop = document.getElementById('custom-modal-backdrop');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirmButton = document.getElementById('modal-confirm-button');
            const modalCancelButton = document.getElementById('modal-cancel-button');
            modalTitle.textContent = title;
            modalMessage.textContent = message;

            if (isConfirmation) {
                modalConfirmButton.classList.remove('hidden');
                modalCancelButton.classList.remove('hidden');
                modalConfirmButton.focus();
            } else {
                modalConfirmButton.classList.add('hidden');
                modalCancelButton.classList.add('hidden');
            }
            modal.classList.remove('hidden');
            backdrop.classList.remove('hidden');

            return new Promise(resolve => { resolveModal = resolve; });
        }
        window.showModal = showModal;

        document.addEventListener('DOMContentLoaded', () => {
            // Modal button listeners
            const modal = document.getElementById('custom-modal');
            const backdrop = document.getElementById('custom-modal-backdrop');
            const modalConfirmButton = document.getElementById('modal-confirm-button');
            const modalCancelButton = document.getElementById('modal-cancel-button');
            const modalCloseButton = document.getElementById('modal-close-button');

            const handleCloseModal = (result) => {
                modal.classList.add('hidden');
                backdrop.classList.add('hidden');
                if (resolveModal) resolveModal(result);
            };

            const handleConfirm = () => handleCloseModal(true);
            const handleCancel = () => handleCloseModal(false);
            const handleClose = () => {
                const result = document.getElementById('modal-confirm-button').classList.contains('hidden') === false ? false : undefined;
                handleCloseModal(result);
            };

            modalConfirmButton.addEventListener('click', handleConfirm);
            modalCancelButton.addEventListener('click', handleCancel);
            modalCloseButton.addEventListener('click', handleClose);
            document.getElementById('custom-modal-backdrop').addEventListener('click', handleClose);

            // Roster Submission Listeners
            document.getElementById('team-login-button').addEventListener('click', handleTeamLogin);
            document.getElementById('submit-roster-button').addEventListener('click', handleSubmitRoster);
            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('clear-roster-button').addEventListener('click', handleClearRoster);

            // NOTE: Initial check is handled by the onAuthStateChanged callback in the Firebase module
            // to ensure data is loaded first.
        });

        // CRITICAL: This function now relies only on in-memory state and the global window.users array
        window.checkSessionTeam = function() {
            const rosterPanel = document.getElementById('roster-panel');
            const rosterDisplayPanel = document.getElementById('roster-display-panel');

            if (currentTeamName && currentTeamId) {
                const team = window.users.find(u => u.id === currentTeamId);

                if (team) {
                    document.getElementById('team-login-panel').classList.add('hidden');
                    document.getElementById('roster-header').textContent = `Manage Roster: ${currentTeamName}`;

                    const isRosterComplete = team.roster.length === TOTAL_PICKS_REQUIRED;

                    if (isRosterComplete) {
                        // Show final display, hide inputs (permanent lockout)
                        rosterPanel.classList.add('hidden');
                        rosterDisplayPanel.classList.remove('hidden');
                        document.getElementById('display-roster-header').textContent = `Final Roster: ${currentTeamName}`;
                        document.getElementById('display-logout-button').onclick = handleLogout;
                        renderFinalRoster(team.roster);
                    } else {
                        // Show inputs, hide final display (draft in progress)
                        rosterPanel.classList.remove('hidden');
                        rosterDisplayPanel.classList.add('hidden');

                        document.getElementById('roster-inputs-container').classList.remove('roster-locked');
                        document.getElementById('submit-roster-button').classList.remove('hidden');
                        document.getElementById('clear-roster-button').classList.remove('hidden');
                        document.getElementById('lock-message').classList.add('hidden');

                        renderRosterInputs(team.roster, isRosterComplete);
                    }
                } else {
                    // User was logged in in-memory, but team vanished from the database (shouldn't happen)
                    handleLogout();
                }
            } else {
                // Not logged in (in-memory state is null)
                document.getElementById('team-login-panel').classList.remove('hidden');
                rosterPanel.classList.add('hidden');
                rosterDisplayPanel.classList.add('hidden');
                document.getElementById('roster-inputs').innerHTML = '';
            }
        }

        // Helper function to create a dropdown menu with exactly 5 players
        function createPlayerDropdown(availablePlayers, currentSelection, pickIndex, pickType, isGoalie, isDisabled) {
            const selectId = `${pickType.toLowerCase()}-select-${pickIndex}`;
            const playerNumber = pickIndex + 1;

            let optionsHtml = `<option value="" disabled ${currentSelection ? '' : 'selected'}>--- Select Player #${playerNumber} ---</option>`;
            let isSelectionInGroup = false;

            availablePlayers.forEach(player => {
                const isSelected = player === currentSelection;
                if (isSelected) isSelectionInGroup = true;
                optionsHtml += `<option value="${player}" ${isSelected ? 'selected' : ''}>${player}</option>`;
            });

            // Add the previously selected player if they are NOT in the limited list (preservation)
            if (currentSelection && !isSelectionInGroup) {
                const fullList = isGoalie ? flatAvailableGoalies : flatAvailableForwards;

                if (fullList.includes(currentSelection)) {
                    optionsHtml = `<option value="${currentSelection}" selected class="bg-yellow-100 text-gray-800 font-bold">[Preserved Pick] ${currentSelection}</option>` + optionsHtml;
                }
            }

            const disabledAttr = isDisabled ? 'disabled' : '';

            return `
                <div class="p-3 bg-white rounded-xl shadow-sm border border-gray-100 mb-3 transition ${isDisabled ? 'roster-locked-item' : 'hover:border-blue-300'}">
                    <label for="${selectId}" class="block text-sm font-semibold text-gray-700 mb-1">Player #${playerNumber}:</label>
                    <div class="relative select-wrapper">
                        <select id="${selectId}"
                                ${disabledAttr}
                                class="${pickType.toLowerCase()}-pick-select w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            ${optionsHtml}
                        </select>
                    </div>
                </div>
            `;
        }

        // Function to render the 21 fixed dropdowns
        function renderRosterInputs(roster, isRosterComplete) {
            const rosterInputs = document.getElementById('roster-inputs');
            rosterInputs.innerHTML = '';

            const currentPicks = roster.map(p => p.name || '');

            // --- FORWARD/DEFENSE PICKS (18 players, 5 players per slot) ---
            let html = '<h3 class="text-xl font-bold text-green-700 mb-4 border-b pb-2">Forward/Defense Selections (18 Players)</h3>';

            for (let i = 0; i < FORWARD_PICKS_COUNT; i++) {
                const selectedName = currentPicks[i] || '';
                const start = i * 5;
                const end = start + 5;
                const pickPlayers = flatAvailableForwards.slice(start, end);

                html += createPlayerDropdown(pickPlayers, selectedName, i, 'Draft', false, isRosterComplete);
            }

            // --- GOALIE PICKS (3 players, 5 players per slot) ---
            html += '<h3 class="text-xl font-bold text-green-700 mt-8 mb-4 border-b pb-2">Goaltender Selections (3 Players)</h3>';

            for (let i = 0; i < GOALIE_PICKS_COUNT; i++) {
                const pickIndex = FORWARD_PICKS_COUNT + i;
                const selectedName = currentPicks[pickIndex] || '';
                const start = i * 5;
                const end = start + 5;
                const pickPlayers = flatAvailableGoalies.slice(start, end);

                html += createPlayerDropdown(pickPlayers, selectedName, pickIndex, 'Goalie', true, isRosterComplete);
            }

            rosterInputs.innerHTML = html;
        }

        // Function to render the final read-only roster table
        function renderFinalRoster(roster) {
            const container = document.getElementById('final-roster-table-container');
            let totalPoints = 0;

            let tableHtml = `
                <table class="min-w-full divide-y divide-gray-200 shadow-md rounded-xl overflow-hidden">
                    <thead class="bg-indigo-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">#</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Player Name</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-indigo-700 uppercase tracking-wider">Points</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
            `;

            roster.forEach((player, index) => {
                const points = player.points || 0;
                totalPoints += points;

                tableHtml += `
                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-indigo-50 transition duration-150">
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-500">${index + 1}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-800 font-semibold">${player.name}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-right text-sm font-bold text-gray-900">${points}</td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                    <tfoot class="bg-indigo-100 border-t-4 border-indigo-700">
                        <tr>
                            <td colspan="2" class="px-6 py-4 text-right text-base font-extrabold text-indigo-900">Total:</td>
                            <td class="px-6 py-4 text-right text-base font-extrabold text-indigo-900">${totalPoints}</td>
                        </tr>
                    </tfoot>
                </table>
            `;

            container.innerHTML = tableHtml;
        }


        async function handleTeamLogin() {
            const teamNameInput = document.getElementById('team-name-input-login').value.trim();
            if (!teamNameInput) { showModal('Input Required', 'Please enter your Team Name (Username).'); return; }

            const existingUser = window.users.find(u => u.teamName.toLowerCase() === teamNameInput.toLowerCase());

            if (existingUser) {
                currentTeamName = existingUser.teamName;
                currentTeamId = existingUser.id;
                showModal('Login Successful', `Welcome back, ${currentTeamName}! Your current selections are loaded.`);
            } else {
                const confirmation = await showModal(
                    'New Team Registration',
                    `The team name "${teamNameInput}" does not exist. Do you want to register a new team with this name?`,
                    true
                );

                if (!confirmation) { return; }

                const newTeam = {
                    id: generateUniqueId(),
                    teamName: teamNameInput,
                    roster: [],
                    totalPoints: 0,
                    individualPlayerScores: []
                };

                currentTeamName = newTeam.teamName;
                currentTeamId = newTeam.id;
                window.users.push(newTeam);

                // Immediately save the new user list to the database
                await window.saveUsersToDatabase(window.users);

                showModal('Registration Complete', `Team ${currentTeamName} has been registered! Please make your selections.`);
            }

            document.getElementById('team-name-input-login').value = '';
            checkSessionTeam();
        }

        async function handleSubmitRoster() {
            if (!currentTeamId || !currentTeamName) { showModal('Error', 'Please log in with a Team Name first.'); return; }

            const submittedRosterNames = [];

            const allSelects = document.querySelectorAll('.draft-pick-select, .goalie-pick-select');
            allSelects.forEach(select => {
                if (select.value) {
                    let playerName = select.value;
                    if (playerName.startsWith('[Preserved Pick]')) {
                        playerName = playerName.replace('[Preserved Pick] ', '');
                    }
                    submittedRosterNames.push(playerName);
                }
            });

            if (submittedRosterNames.length !== TOTAL_PICKS_REQUIRED) {
                showModal('Submission Error', `You must select all ${TOTAL_PICKS_REQUIRED} players (18 F/D, 3 G) before submitting your final roster. Currently selected: ${submittedRosterNames.length}`);
                return;
            }

            const uniquePicks = new Set(submittedRosterNames);
            if (uniquePicks.size !== submittedRosterNames.length) {
                showModal('Duplicate Pick Detected', 'You have selected the same player more than once. Please check your selections and ensure each player is unique before submitting.', false);
                return;
            }

            const submittedRosterObjects = submittedRosterNames.map(name => {
                const isGoalie = flatAvailableGoalies.includes(name);
                const position = isGoalie ? 'G' : 'F/D';

                return {
                    id: generateUniqueId(),
                    name: name,
                    points: 0,
                    position: position,
                    overallRank: 0
                };
            });

            const newUsers = window.users.map(user => {
                if (user.id === currentTeamId) {
                    return { ...user, roster: submittedRosterObjects };
                }
                return user;
            });

            window.users = newUsers;

            await window.saveUsersToDatabase(newUsers);

            showModal('Roster Submitted & Locked!', `Your final roster with ${submittedRosterNames.length} players has been saved and is now locked for ${currentTeamName}!`);

            window.checkSessionTeam();
        }

        async function handleClearRoster() {
             if (!currentTeamId) return;
             const confirmation = await showModal('Confirm Clear', `Are you sure you want to clear ALL player selections for ${currentTeamName}? This action is usually only done during the draft process.`, true);
             if (!confirmation) return;

             const newUsers = window.users.map(user => {
                if (user.id === currentTeamId) {
                    return { ...user, roster: [] };
                }
                return user;
            });

            window.users = newUsers;

            await window.saveUsersToDatabase(newUsers);
            window.checkSessionTeam();
            showModal('Selections Cleared', `All draft selections for ${currentTeamName} have been reset. Please make new picks and SUBMIT.`);
        }

        // CRITICAL: This function now clears only the in-memory session state
        function handleLogout() {
            currentTeamName = null;
            currentTeamId = null;
            checkSessionTeam();
        }

    })();
  </script>
</head>
<body class="p-4 md:p-8 bg-gray-50">
<!-- Loading Overlay -->
<div id="loading-overlay" class="loading-overlay">
  <div class="text-center">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto"></div>
    <p class="mt-4 text-lg text-green-600 font-semibold">Connecting to Cloud Database...</p>
  </div>
</div>

<!-- Custom Modal Structure -->
<div id="custom-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden"></div>
<div id="custom-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-100" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="flex justify-between items-center p-5 border-b border-gray-200">
      <h3 id="modal-title" class="text-xl font-bold text-gray-900">Modal Title</h3>
      <button id="modal-close-button" class="text-gray-400 hover:text-gray-600 transition">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
      </button>
    </div>
    <div class="p-5">
      <p id="modal-message" class="text-gray-700"></p>
    </div>
    <div class="p-5 border-t border-gray-200 flex justify-end space-x-3">
      <button id="modal-cancel-button" class="hidden px-4 py-2 text-sm font-semibold text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition focus:outline-none">
        Cancel
      </button>
      <button id="modal-confirm-button" class="hidden px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700 transition focus:outline-none">
        Confirm
      </button>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="max-w-xl mx-auto">
  <header class="text-center mb-8 p-4 bg-white rounded-xl shadow-lg">
    <h1 class="text-4xl font-extrabold text-green-700">Team Roster Entry</h1>
    <p class="text-gray-500 mt-2">Submit your **21-player draft selections** below.</p>
    <p class="mt-4 text-sm text-gray-600">
      <a href="master.html" class="font-bold text-blue-500 hover:text-blue-700 underline">Go to Admin/Rankings Page (Requires Master Login)</a>
    </p>
  </header>

  <!-- Team Login Panel -->
  <div id="team-login-panel" class="p-6 bg-white rounded-xl shadow-lg border border-blue-100 mb-8">
    <h2 class="text-2xl font-bold text-blue-600 mb-4">Team Login / Register</h2>
    <p class="text-gray-600 mb-4">Enter your team name (username) to submit your roster. New names will be registered automatically. (Data syncs across devices.)</p>

    <input type="text" id="team-name-input-login" placeholder="Your Team Name (e.g., Connor)" class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg">

    <button id="team-login-button" class="w-full bg-blue-500 text-white p-3 rounded-lg font-semibold hover:bg-blue-600 transition shadow-md">
      Login / Register Team
    </button>
  </div>

  <!-- Roster Management Panel (Hidden by default - Selection Window) -->
  <div id="roster-panel" class="p-6 bg-white rounded-xl shadow-lg border border-green-100 mb-8 hidden">
    <div class="flex justify-between items-center mb-4">
      <h2 id="roster-header" class="text-2xl font-bold text-green-600">Manage Roster</h2>
      <button id="logout-button" class="text-sm text-gray-500 hover:text-gray-700 underline">Logout</button>
    </div>

    <p id="lock-message" class="hidden bg-indigo-100 text-indigo-700 p-3 rounded-lg font-medium text-center mb-6 border-l-4 border-indigo-500">
      ✅ **Roster Complete & Locked!** You have selected all 21 players.
    </p>

    <!-- Roster Input Container (Fixed 21 Dropdowns inserted here) -->
    <div id="roster-inputs-container">
      <div id="roster-inputs" class="space-y-4">
        <!-- Dropdowns are inserted by renderRosterInputs() -->
      </div>
    </div>

    <div class="flex space-x-4 mt-8">
      <button id="submit-roster-button" class="flex-1 bg-green-600 text-white p-4 rounded-xl font-extrabold hover:bg-green-700 transition shadow-lg">
        SUBMIT & SAVE ROSTER (21 PICKS)
      </button>
      <button id="clear-roster-button" class="w-24 bg-red-500 text-white p-4 rounded-xl font-semibold hover:bg-red-600 transition shadow-lg" title="Clear All Selections">
        Clear
      </button>
    </div>
  </div>

  <!-- Final Roster Display Panel (Hidden by default - Locked View) -->
  <div id="roster-display-panel" class="p-6 bg-white rounded-xl shadow-lg border border-indigo-200 mb-8 hidden">
    <div class="flex justify-between items-center mb-4">
      <h2 id="display-roster-header" class="text-2xl font-bold text-indigo-700">Final Roster: Team Name</h2>
      <button id="display-logout-button" class="text-sm text-gray-500 hover:text-gray-700 underline">Logout</button>
    </div>
    <p class="text-indigo-600 mb-4 font-medium border-b pb-2">This is your locked, final 21-player roster. Points will update here automatically.</p>
    <div id="final-roster-table-container">
      <!-- Roster table inserted here by renderFinalRoster() -->
    </div>
  </div>
</div>
</body>
</html>